<ui:composition template="/WEB-INF/templates/layout.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core">

    <ui:define name="content">
        <h:form>
            <h:panelGrid columns="2" columnClasses="top,top" styleClass="w-100">
                <h:panelGroup layout="block" styleClass="iw-panel">
                    <h:panelGroup layout="block" styleClass="iw-panel-content">
                        <h:outputLabel for="query_input" value="Search query: "/>

                        <h:inputText id="query_input" label="query" required="true" value="#{searchBean.query}" size="30"/>
                        <h:commandButton action="#{searchBean.search()}" value="Search" id="search_button"/>
                    </h:panelGroup>
                </h:panelGroup>
                <h:panelGrid columns="3" columnClasses="top,top,top" styleClass="w-100">
                    <h:panelGroup layout="block" styleClass="iw-panel bordered">
                        <h:panelGroup layout="block" styleClass="iw-panel-header">
                            <h:outputText value="Params"/>
                        </h:panelGroup>
                        <h:panelGroup layout="block" styleClass="iw-panel-content table-form">
                            <h:outputLabel for="count_input" value="Results: "/>
                            <h:inputText id="count_input" label="results count" required="true" value="#{searchBean.resultCount}" size="4"/>

                            <h:outputLabel for="page_input" value="Page: "/>
                            <h:selectOneListbox id="page_input" value="#{searchBean.page}" size="1">
                                <f:selectItem itemValue="1"/>
                                <f:selectItem itemValue="2"/>
                                <f:selectItem itemValue="3"/>
                                <f:selectItem itemValue="4"/>
                                <f:selectItem itemValue="5"/>
                                <f:selectItem itemValue="6"/>
                            </h:selectOneListbox>

                            <h:outputLabel for="lang_input" value="Language: "/>
                            <h:inputText id="lang_input" required="true" value="#{searchBean.language}" size="2" maxlength="2"/>

                            <h:outputLabel for="timeout_input" value="Timeout: "/>
                            <h:inputText id="timeout_input" required="true" value="#{searchBean.timeout}" size="3" maxlength="3"/>
                        </h:panelGroup>
                    </h:panelGroup>
                    <h:panelGroup layout="block" styleClass="iw-panel bordered">
                        <h:panelGroup layout="block" styleClass="iw-panel-header">
                            <h:outputText value="Connectors"/>
                        </h:panelGroup>
                        <h:panelGroup layout="block" styleClass="iw-panel-content">
                            <h:selectManyCheckbox id="connectors" value="#{searchBean.selectedConnectorNames}" layout="pageDirection">
                                <f:selectItems value="#{searchBean.connectorNames}"/>
                                <f:ajax event="change" render="content_types"/>
                            </h:selectManyCheckbox>
                        </h:panelGroup>
                    </h:panelGroup>
                    <h:panelGroup layout="block" styleClass="iw-panel bordered">
                        <h:panelGroup layout="block" styleClass="iw-panel-header">
                            <h:outputText value="Supported content types"/>
                        </h:panelGroup>
                        <h:panelGroup layout="block" styleClass="iw-panel-content">
                            <h:selectManyCheckbox id="content_types" value="#{searchBean.selectedContentTypes}" layout="pageDirection">
                                <f:selectItems value="#{searchBean.contentTypes}"/>
                                <f:ajax event="change" execute="#{searchBean.save()}"/>
                            </h:selectManyCheckbox>
                        </h:panelGroup>
                    </h:panelGroup>
                </h:panelGrid>
            </h:panelGrid>
        </h:form>

        <ui:fragment rendered="#{searchBean.hasResults()}">
            <h:outputText value="No results found" rendered="${searchBean.searchResults.size()==0}"/>
            <h:outputText value="${searchBean.searchResults.resultItems.size()} result(s) found (${searchBean.searchResults.elapsedTime/1000} s), total results available ${searchBean.searchResults.totalResults}."
                          rendered="${searchBean.searchResults.size()>0}"/>
        </ui:fragment>

        <h:form rendered="#{searchBean.hasResults()}">
            <h:dataTable value="#{searchBean.searchResults.resultItems}" var="resultItem" id="result_table" styleClass="iw-datatable w-100">
                <h:column>
                    <span style="text-align: left;">#{searchBean.getResultIndex(resultItem)+1}</span>
                </h:column>

                <h:column>
                    <span style="white-space: nowrap;">
                        <img src="#{searchBean.getConnectorBaseUrl(resultItem.serviceName)}/favicon.ico" alt="#{resultItem.serviceName}"
                             style="vertical-align: middle; margin: 3px; width: 16px;"/>

                        <h:outputText value="#{resultItem.serviceName}"/>
                    </span>
                </h:column>

                <h:column>
                    <div>
                        <h6>
                            <img src="#{request.contextPath}/img/#{searchBean.getTypeImageUrl(resultItem.type)}" alt="#{resultItem.type}}"
                                 style="vertical-align: middle; margin: 3px; width: 16px;"/>

                            <h:outputLink value="#{resultItem.url}" target="_blank">
                                <h:outputText value="#{resultItem.title}" escape="false"/>
                            </h:outputLink>
                        </h6>
                        <div>
                            <h:outputLink value="#{resultItem.url}" target="_blank" style="border-width: 0;">
                                <ui:fragment rendered="#{resultItem.thumbnailSmall ne null}">
                                    <img src="#{resultItem.thumbnailSmall.url}" alt="#{resultItem.title}" class="img-fluid"
                                         width="#{resultItem.thumbnailSmall.width}" height="#{resultItem.thumbnailSmall.height}"/>
                                    <hr/>
                                </ui:fragment>
                                <ui:fragment rendered="#{resultItem.thumbnailMedium ne null}">
                                    <img src="#{resultItem.thumbnailMedium.url}" alt="#{resultItem.title}" class="img-fluid"
                                         width="#{resultItem.thumbnailMedium.width}" height="#{resultItem.thumbnailMedium.height}"/>
                                    <hr/>
                                </ui:fragment>
                                <ui:fragment rendered="#{resultItem.thumbnailLarge ne null}">
                                    <img src="#{resultItem.thumbnailLarge.url}" alt="#{resultItem.title}" class="img-fluid"
                                         width="#{resultItem.thumbnailLarge.width}" height="#{resultItem.thumbnailLarge.height}"/>
                                    <hr/>
                                </ui:fragment>
                            </h:outputLink>

                            <ui:fragment rendered="#{resultItem.embeddedUrl ne null}">
                                <iframe src="#{resultItem.embeddedUrl}" allowfullscreen="allowfullscreen" referrerpolicy="origin">Your browser has blocked this iframe</iframe>
                            </ui:fragment>

                            <div>
                                <h:outputText value="#{resultItem.description}" escape="false"/>

                                <ui:fragment rendered="#{not empty resultItem.snippet}">
                                    <pre style="color: #3399FF;"><h:outputText value="#{resultItem.snippet}" escape="false"/></pre>
                                </ui:fragment>
                            </div>

                            <div>
                                <span style="text-align: left; vertical-align: bottom; color: #008080; font-size: 0.8em;">
                                    <span style="background-color: #D0EFEF;">Added</span>:#{resultItem.date} -
                                    <span style="background-color: #D0EFEF;">Tags</span>:#{searchBean.getTags(resultItem)} -
                                </span>
                            </div>
                        </div>
                    </div>
                </h:column>
            </h:dataTable>
        </h:form>
    </ui:define>

</ui:composition>
